

<div class="container search-index-box">


  <div class="row post-header">
    <div class="col-md-6">
      <h1>
        <%=@post.title%><% if can_edit? @post %>
          <a href="<%= edit_post_path @post %>?layer_id=<%= @current_layer.nil? ? '' : @current_layer.id %>"><button style="border-radius: 10px"><span><i class="glyphicon glyphicon-pencil"></i></span></button>
          </a>
        <% end %>
      </h1>
    </div>
    <div class="col-md-3 col-md-offset-3">
      <p class="text-right">By <%= link_to @post.user.full_name, profile_user_path(id: @post.user.slug)  %></p>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h2>
        Area:  <%= @post.area.name %>
      </h2>
    </div>
    <div class="col-md-3 col-md-offset-3">
      Layer:
      <select name="layer_sel" id="layer_sel">
        <% if @current_layer.nil? %>
          <option value="/posts/<%= @post.slug %>" selected="selected">Public</option>
          <% @post.layers.each do |l| %>
            <option value="/posts/<%= @post.slug %>?layer=<%= l.name %>">
              <%=  l.name %>
            </option>
          <% end %>
        <% else %>
          <option value="/posts/<%= @post.slug %>">Public</option>
          <% @post.layers.each do |l| %>
            <option value="/posts/<%= @post.slug %>?layer=<%= l.name %>" selected="<%= 'selected' if l.name == @current_layer.name %>">
              <%=  l.name %>
            </option>
          <% end %>
        <% end %>
        <option value="<%= new_layer_post_path(@post) %>">Add a new Layer.</option>
      </select>
    </div>
  </div>

  <div class="row post-show-button-box">
    <div class="col-md-12">
      <% if @post.post_type == 'Problem'%>
        <%= link_to posts_path(post_type: 'Idea', tags_filter: @post.all_tags.split(", ")[0], parent_id: @post.id) do %>
          <span class="badge badge-success"><%= @post.ideas.count %> Ideas</span>
        <% end %>
      <% end %>
      </h1>
    </div>
  </div>

  <div class="row post-show-text-box">
    <div class="col-md-12">
      <% if @current_layer.nil?%>
        <div class="post-body">
          <%= @post.post_body.html_safe %>
        </div>
      <% else %>
        <div class="post-body">
          <%= @current_layer.layer_body.html_safe %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row post-show-rate-box">
    <div class="col-md-4">
      <% 1.upto(5) do |star_index| %>
        <% if star_index <= @post.avg_rating %>
          <span class="glyphicon glyphicon-star rating" data-sindex="<%= star_index %>"></span>
        <% else %>
          <span class="glyphicon glyphicon-star-empty rating" data-sindex="<%= star_index %>"></span>
        <% end %>
      <% end %>

      <% unless @rated.nil? %>
        <span id="rated"><i>You Rated <strong class="rate_count"> <%= @rated.score %></strong> Stars.</i></span>
      <% else %>
        <span id="rated" style="display: none;"><i>You Rated <strong class="rate_count"></strong> Stars.</i></span>
      <% end %>
    </div>
    <div class="col-md-4 col-md-offset-4">
    <span><i class="glyphicon glyphicon-calendar"></i> <%= @post.created_at.strftime("%I:%M %p, %d/%m/%Y") %> </span>
  </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <ul class="list-inline list-unstyled">
        <% if @post.post_type == 'Problem'%>
          <li>
            <%= link_to new_post_path(post_type: "Idea",area: @post.area, parent_post_id: @post.id), class: "btn btn-primary" do %>
              <span class="glyphicon glyphicon-bell"></span>
              Give an Idea
            <% end %>
          </li>
        <% end %>
        <% if @post.post_type == 'Idea' and  @post.parent_post_id != nil %>
          <li>
            <%= link_to post_path(id: @post.parent_slug), data: { 'turbolinks': false }, class: "btn btn-primary" do %>
              <span class="glyphicon glyphicon-zoom-in"></span>
              See the Problem
            <% end %>
          </li>
        <% end %>

        <% if @post.post_type == 'Proposal' and  @post.parent_post_id != nil %>
          <li>
            <%= link_to post_path(id: @post.parent_slug), data: { 'turbolinks': false }, class: "btn btn-primary" do %>
              <span class="glyphicon glyphicon-zoom-in"></span>
              See the Idea
            <% end %>
          </li>
        <% end %>

        <% unless @post.post_type == 'Proposal' %>
          <li>
            <%= link_to new_post_path(post_type: "Proposal", area: @post.area, parent_post_id: @post.id), class: "btn btn-primary" do %>
              <span class="glyphicon glyphicon-wrench"></span>
              Give a Proposal
            <% end %>
          </li>
        <% end %>
        <li>
          <%= link_to new_layer_post_path(@post), class: "btn btn-primary" do %>
            <span class="glyphicon glyphicon-duplicate"></span>
            Add a Layer
          <% end %>
        </li>
        <li>
          <%= form_for @track, class: "form-horizonatl" do |f| %>
            <%= hidden_field_tag(:post_id, @post.id) %>
            <%= f.submit 'Track', class: 'btn btn-primary' %>
          <%end%>
        </li>
      </ul>
    </div>
  </div>

  <!-- Add Token Modal -->
  <div class="modal" id="add-token">

      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Add a
          <%= select_tag 'token_type', options_for_select([["Note","Note"],["Debate","Debate"],["Question","Question"]]) %>
          Token.
          </h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <!-- Modal body -->
        <div class="modal-body">
          <%= form_tag(create_token_post_path, method: :post, remote: true, id: :token_form  ) do %>
            <div class="form-group required">
            <p id="tkn-info">
              Give the details of the Note token.
            </p>
            <%= text_area_tag "token_body","",name: 'token_body', class: "tinymce", rows: 40 , cols: 120 %>
            <%= tinymce %>
            <%= hidden_field_tag(:span_id) %>
            <%= hidden_field_tag(:tkntype) %>
            <%= hidden_field_tag(:layer_id) %>
            <button type="submit" id="tkn_form_btn" class="btn btn-success">Add Token</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
        <% end %>
    </div>
  </div>

  </div>
  </div>
  </div>

  <!-- Rate Post Modal -->
  <div class="modal" id="rate-post">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">
          Do you want to rate this <%= @post.post_type %> <strong class="rate_count"></strong> stars ?
          </h4>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <%= form_tag(add_rating_post_path, method: :post, remote: true, id: :rating_form  ) do %>

            <div class="form-group required">
            <div id="stars_form">

            </div>
            <%= hidden_field_tag(:score) %>
            <button type="submit" id="tkn_form_btn" class="btn btn-success">Yes</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Don't Rate</button>
            </div>
        </div>

        <% end %>
      </div>
    </div>
  </div>
<% content_for :token_purse do %>
  <span class='tkn-n token' data-type='Note'>N</span><span id="n_rem_count" class='label label-danger' style="border-radius: 50%"><%= @tokens_count[0] %></span>
  <span class='tkn-n token' data-type='Debate'>D</span><span id="d_rem_count" class='label label-danger' style="border-radius: 50%"><%= @tokens_count[1] %></span>
  <span class='tkn-n token' data-type='Question'>Q</span><span id="q_rem_count" class='label label-danger' style="border-radius: 50%"><%= @tokens_count[2] %></span>
<% end %>
</div>

<script type="text/javascript">
  function fetch_and_add_token(){
  $.get("<%= all_tokens_post_path %>?layer=<%= @current_layer.nil? ? nil : @current_layer.id %>", function(data, status){
    data.map(function(obj){
      //console.log(obj)
      $('#'+obj.span_id).after("<span class='tkn-n'><a href='<%= show_token_post_path %>?token_id="+ obj.id+"'><strong>"+obj.token_type[0]+"</strong></a></span>");
    })
});
} 
fetch_and_add_token();


<% unless @current_layer.nil? %>
  // select the current layer
   $('#layer_sel option:contains("<%= @current_layer.name %>")').prop("selected","selected");
   $('#layer_id').val("<%= @current_layer.id %>");
  <% else %>
   $('#layer_sel option:contains("Primary")').prop("selected","selected");
<% end %>

</script>




